<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- If for some reason you are using IE, use edge -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- So bootstrap isn't horrible, set the width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  <title>CS 341 · Deadlock Demolition</title>

  <!-- Reference a CDN so this is properly cached in the browser forever. Unless they clean out the
       Cache this will incur no load time. Ideally we should put a security checksum but that breaks
       Firefox development sometimes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
  <!-- For table of content  -->

  <link rel="stylesheet" href="/css/code-style.css"/>
  <link rel="stylesheet" href="/css/main.css"/>
  <link rel="stylesheet" href="/css/bootstrap-toc.css"/>

  <meta property="og:locale" content="en_US">

  
  <meta property="og:title" content="Deadlock Demolition" />
  

  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://cs341.cs.illinois.edu" />

  
  <meta property="og:description" content=""Webpage for CS 341: System Programming at the University of Illinois Urbana-Champaign. All documentation and information about the course can be found here."
" />
  

</head>


<body data-spy="scroll" data-target="#overview" data-offset="50">
  <div class="container-fluid">
    <div class="row" style="display: flex; justify-content: stretch;">
      <!-- Always shows a header, even in smaller screens. -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <!-- Navigation button as html so we don't have to resize images -->
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
        <!-- Hamburger Navigation bar on small -->
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <!-- Full title on laptop -->
      <a class="navbar-brand navbar-item normal" href="/">
             <span>CS 341: System Programming</span> 
      </a>

      <!-- Smaller on mobile-->
      <a class="navbar-brand navbar-item small" href="/">
          <span>CS 341</span>
      </a>
    </div>

    <!-- Finally generate what is in the navbar -->
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
        <li class="navbar-item">
          <a href="/assignments.html">Assignments</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/quiz_topics.html">Quizzes</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/grades.html">Grades</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/schedule.html">Lectures</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/syllabus.html">Syllabus</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/staff.html">Staff</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/resources.html">Resources</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
            <li class="navbar-subitem">
              <a href="/peer_tutoring.html">Peer Tutoring</a>
            </li>
            
            <li class="navbar-subitem">
              <a href="/coursebook/index.html">Coursebook</a>
            </li>
            
            <li class="navbar-subitem">
              <a href="">Lecture Materials</a>
            </li>
            
            <li class="navbar-subitem">
              <a href="/tutorials/development">Linux Virtual Machine</a>
            </li>
            
          </ul>
        </li>
        
        <li class="navbar-item">
          <a href="/honors.html">Honors</a>
          <!-- Generate sublinks-->
          <ul class="nav navbar-nav subitem-container">
            
          </ul>
        </li>
        
      </ul>
    </div>
  </div>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</nav>

      <div class="row">
        <div class="col-sm-3 col-xs-12 hidden-xs" style="min-height: 100%">
          <nav id="overview" data-toggle="toc" class="sticky-top"></nav>
        </div>
        <div class="col-sm-9 col-xs-12">
          <div class="title">
            
            
            
            <h1>
              Deadlock Demolition
            </h1>
          </div>
          <div class="content col-sm-11 .col-sm-offset-1">
            
            <div class="submission-wrapper">
              
              <b>Entire Assignment</b> due <b>2025-03-12 23:59</b><br>
              
              <b>Graded files:</b>
              <ul>
                
                <li>libdrm.c</li>
                
              </ul>
              
              
            </div>
            
          </div>
          <div class="hidden-sm hidden-md hidden-lg">
            
            <div class="toc-wrapper">
<h4>Content</h4>
<ul class="toc">
<li><a id="toc_backstory" href="#backstory" class="fancy-link">Backstory</a></li>
<li><a id="toc_overview" href="#overview" class="fancy-link">Overview</a></li>
<li><a id="toc_functionality" href="#functionality" class="fancy-link">Functionality</a></li>
<li><a id="toc_resource-allocation-graph" href="#resource-allocation-graph" class="fancy-link">Resource Allocation Graph</a></li>
<li><a id="toc_algorithm" href="#algorithm" class="fancy-link">Algorithm</a></li>
<li><a id="toc_testing" href="#testing" class="fancy-link">Testing</a></li>
</ul>
</div>
            
          </div>
          <div id="content">
            
  <h2 id="learning-objectives">Learning Objectives</h2>
  <p>
    The learning objectives for Deadlock Demolition are: <br>
    </p>
<ul class="mdl-list">
      
        <li class="mdl-list__item">
          <span class="mdl-list__item-primary-content">Synchronization Primitives</span>
        </li>
      
        <li class="mdl-list__item">
          <span class="mdl-list__item-primary-content">Deadlock Detection</span>
        </li>
      
        <li class="mdl-list__item">
          <span class="mdl-list__item-primary-content">Resource Allocation Graph</span>
        </li>
      
    </ul>
  



            <div class="wrapper">
<div class="pad"><div class="card">
<div class="title"><h2 id="backstory" class="title-text">Backstory<a class="anchor title-text" href="#backstory"> #</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<blockquote>
  <p>Do you suffer from writing multithreaded code that deadlocks? Wish that the mutexes would provide feedback instead of deadlocking? Well have no fear, the drms are here! drm, short for deadlock-resistant mutex, are mutexes that will notify you when an attempt to lock them would cause a deadlock! Fancy, right? With this, you won’t ever need to worry about deadlock ever again!</p>
</blockquote>
<p>Your friend, and work partner Foo showed you the presentation slides which will introduce your project in the upcoming Cool C Libraries Fair. The both of you have decided to implement a mutex library that prevents deadlock, and Foo was so excited that they made the presentation slides <em>before</em> even implenting the library itself. Facepalming at Foo’s lack of proper workflow priorities, you decide to just work on it, and have Foo create the tests and videos that will show off the drm’s capabilities.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="overview" class="title-text">Overview<a class="anchor title-text" href="#overview"> #</a>
</h2></div>




<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>A drm behaves exactly like a <code class="language-plaintext highlighter-rouge">pthread_mutex_t</code>, but will prevent deadlocks from ever occurring. This is done by not allowing a thread to lock the drm if the attempt to lock it would result in deadlock. For example, suppose you had two threads, and two drms: <code class="language-plaintext highlighter-rouge">drm_1</code> and <code class="language-plaintext highlighter-rouge">drm_2</code>. Then,</p>
<ul>
  <li>thread 1 locks <code class="language-plaintext highlighter-rouge">drm_1</code>.</li>
  <li>thread 2 locks <code class="language-plaintext highlighter-rouge">drm_2</code>.</li>
  <li>thread 1 tries to lock <code class="language-plaintext highlighter-rouge">drm_2</code>, and waits.</li>
  <li>thread 2 tries to lock <code class="language-plaintext highlighter-rouge">drm_1</code>. Notice that this call will cause a deadlock. Your drm library will detect this, and reject thread 2’s request to lock <code class="language-plaintext highlighter-rouge">drm_1</code>.</li>
</ul>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="functionality" class="title-text">Functionality<a class="anchor title-text" href="#functionality"> #</a>
</h2></div>









<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>We will use binary semaphore notation for your drm’s functions: i.e. post is equivalent to unlocking and wait is equivalent to locking.</p>
<p>You will be writing four functions:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">drm_t *drm_init();</code></li>
  <li><code class="language-plaintext highlighter-rouge">int drm_post(drm_t *drm, pthread_t *thread_id);</code></li>
  <li><code class="language-plaintext highlighter-rouge">int drm_wait(drm_t *drm, pthread_t *thread_id);</code></li>
  <li><code class="language-plaintext highlighter-rouge">void drm_destroy(drm_t *drm);</code></li>
</ul>
<p>The details of what these functions do can be found in the header file <code class="language-plaintext highlighter-rouge">libdrm.h</code>.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="resource-allocation-graph" class="title-text">Resource Allocation Graph<a class="anchor title-text" href="#resource-allocation-graph"> #</a>
</h2></div>









<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>To detect deadlock, you will need to maintain a <a href="http://cs341.cs.illinois.edu/coursebook/Deadlock#resource-allocation-graphs" class="fancy-link wiki-link">Resource Allocation Graph</a> and be able to perform cycle detection on it. To assist you with this, we have provided you an implementation of a graph data structure. See <code class="language-plaintext highlighter-rouge">graph.h</code> for details on how to use the graph.</p>
<p>Since your Resource Allocation Graph will need to represent both drm locks and threads as vertices, use a shallow graph. You will need to lazy initialize a global graph in <code class="language-plaintext highlighter-rouge">drm_init()</code>. Here is an example of lazy initialization with an integer variable:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="n">g</span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>
<p><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> <strong>The provided graph data structure is not thread-safe.</strong></p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="algorithm" class="title-text">Algorithm<a class="anchor title-text" href="#algorithm"> #</a>
</h2></div>













<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p><code class="language-plaintext highlighter-rouge">drm_init()</code> and <code class="language-plaintext highlighter-rouge">drm_destroy()</code> are straighforward, you only need to allocate and destroy resources. The fun happens in <code class="language-plaintext highlighter-rouge">drm_wait()</code> and <code class="language-plaintext highlighter-rouge">drm_post()</code>.</p>
<h3 id="drm_post" class="title-text"><code class="language-plaintext highlighter-rouge">drm_post()</code></h3>
<p>When a thread calls <code class="language-plaintext highlighter-rouge">drm_post()</code>:</p>
<ul>
  <li>Check to see if the vertex is in the graph. If it is not, return without unlocking the <code class="language-plaintext highlighter-rouge">drm_t</code>.</li>
  <li>Otherwise, if an edge from the drm to the thread exists, remove the edge and unlock the <code class="language-plaintext highlighter-rouge">drm_t</code>.</li>
</ul>
<h3 id="drm_wait" class="title-text"><code class="language-plaintext highlighter-rouge">drm_wait()</code></h3>
<p>When a thread calls <code class="language-plaintext highlighter-rouge">drm_wait()</code>:</p>
<ul>
  <li>Add the thread to the Resource Allocation Graph if not already present. Hint: what unique identifier can you use for each thread?</li>
  <li>Add the appropriate edge to the Resource Allocation Graph.</li>
  <li>Check if the attempt to lock the drm by the thread would cause deadlock.</li>
  <li>If the attempt to lock the drm would cause a deadlock, then reject the locking attempt by returning without locking the drm.
    <ul>
      <li>One case that would deadlock is a thread trying to lock a mutex it already owns. Think about how to factor this in.</li>
      <li>Another case is if the newly added edge creates a cycle in the Resource Allocation Graph.</li>
    </ul>
  </li>
  <li>If not, then lock the drm. Note that you may need to modify the edges of the Resource Allocation Graph in this step.</li>
</ul>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="testing" class="title-text">Testing<a class="anchor title-text" href="#testing"> #</a>
</h2></div>























<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p><strong>Testing is ungraded, but highly recommended</strong></p>
<p>You should test your drm library thoroughly. We’ve given you a <code class="language-plaintext highlighter-rouge">libdrm_tester.c</code> file to write tests in. The tester file comes with an example on how to use the drm. You will need to create more involved tests to ensure that your drm behaves correctly.</p>
<h3 id="testing-tips" class="title-text">Testing Tips</h3>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge"><a href="https://man7.org/linux/man-pages/./man3/pthread_self.3p.html" class="fancy-link">pthread_self</a></code> may be useful for this lab.</li>
  <li>You will want to write test cases where there is no deadlock, to ensure your drm behaves like a normal <code class="language-plaintext highlighter-rouge">pthread_mutex_t</code>.</li>
  <li>You will also want to write test cases where there is deadlock. Perhaps a different synchronization primitive you’ve learned in class can assist you to artificially create deterministic deadlocks…</li>
  <li>Consider logging important events inside of your functions.</li>
  <li>Ensure that your return values are correct.</li>
  <li>Note that you will have still reachable memory in your Resource Allocation Graph upon program termination. That is expected behavior, and still reachable memory is not considered a memory leak.</li>
</ul>
<h3 id="edge-cases-and-undefined-behavior" class="title-text">Edge Cases and Undefined Behavior</h3>
<p>Anything not specified in these docs or the header files is considered undefined behavior. We will not test undefined behavior. Some examples:</p>
<ul>
  <li>initializing a drm that is already initialized.</li>
  <li>calling <code class="language-plaintext highlighter-rouge">drm_destroy()</code> on a locked drm.</li>
</ul>
<h3 id="thread-sanitizer" class="title-text">Thread Sanitizer</h3>
<p>We have another target executed by typing <code class="language-plaintext highlighter-rouge">make tsan</code>. This compiles your code with Thread Sanitizer.</p>
<p>ThreadSantizer is a race condition detection tool. See <a href="http://cs341.cs.illinois.edu/coursebook/Background#tsan" class="fancy-link wiki-link">this page</a> for more information.</p>
<p><strong>We will be using ThreadSanitizer to grade your code, but we will ONLY test for data race warnings, NOT any other warning type.</strong></p>
<p>Good luck!</p>
</div></div></div>
</div></div>
</div>
            
            <div class="wrapper">
</div>
          </div>
          <div class="col-md-2 col-sm-1 col-xs-0"></div>
        </div>
        <!-- Mathjax takes a while to load so do a lazy load to so we can get accessibility -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script>

<!-- Bring in JQuery and Bootstrap -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>
<!-- For table of content -->
<script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>
<script src="/js/scroll.js"></script>
<footer class="">

<!-- Add another container at the bottom so there is some space there -->
<div class="container-fluid">
<div class="shadow"></div>

</div>

</footer>

      </div>
    </div>
  </div>
  <script type="application/javascript">
    var github_repo = "illinois-cs241/illinois-cs241.github.io";
    var github_path = "_docs/deadlock_demolition.md";
  </script>
</body>

</html>